<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
  </head>
  <body>
    <div>
        <h1>Card info</h1>
        <div id="divCardInfo"></div>
    </div>

    <script
    src="https://code.jquery.com/jquery-3.7.1.js"
    integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"></script>
    <script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
    <script src="https://api.trello.com/1/client.js?key=fa9839f60d54e160ba1ec46ce926abd5"></script>

    <script>
        // jQuery Ready 簡寫
        $(function(){
            var objVar = getUrlVar();
            var objAreaCardInfo = $('#divCardInfo');

            // console.log(objVar);
            ApiCard();

            function ApiCard(){
                $.ajax({
                    url: `http://localhost/EMSAPI/actapi/Trello/GetCard/${objVar.id}`, 
                    method: "GET",
                    dataType: "json", 
                    //data: data,
                    success: function(data) {
                        // 成功
                        let jsonCard = JSON.parse(data.output);
                        let aryAllowKey = ['id', 'due', 'desc', 'labels', 'name'];
                        let aryTable=[];

                        aryTable.push('<table>');
                            $.each(jsonCard, function (k, v) {
                                if (aryAllowKey.indexOf(k) < 0) return; //continute
                                aryTable.push('<tr>');
                                aryTable.push(`<th>${k}</th>`);
                                //labels = array
                                if(k=='labels'){
                                    let aryLabels = [];
                                    $.each(v, function (vi, vo) {
                                        aryLabels.push(`${vi.name}[${vo.color}]`);
                                    });
                                    aryTable.push(`<td>${aryLabels.join(';')}</td>`);
                                }
                                else
                                    aryTable.push(`<td>${v}</td>`);
                                aryTable.push('</tr>');
                            });
                        aryTable.push('</table>');

                        objAreaCardInfo.html(aryTable.join(''));
                    },
                    error: function(xhr, status, error) {
                        objAreaCardInfo.html(`API FAIL`);
                    }
                });
            }

            function getUrlVar() {
                var objVar = {}, hash;
                var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                for (var i = 0; i < hashes.length; i++) {
                    hash = hashes[i].split('=');
                    objVar[hash[0]] = hash[1];
                }
                return objVar;
            }
        });
        
    </script>
  </body>
</html>