<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css" />
  </head>
  <body>
    <div id="divOuter">
        <h1>Card info</h1>
        <div id="divCardInfo"></div>
    </div>

    <script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script src="https://api.trello.com/1/client.js?key=fa9839f60d54e160ba1ec46ce926abd5"></script>

    <script>
        // jQuery Ready 簡寫
        $(function(){
            var objVar = getUrlVar();
            var objAreaCardInfo = $('#divCardInfo');

            // console.log(objVar);
            ApiCard();

            function ApiCard(){
                $.ajax({
                    url: `http://localhost/EMSAPI/actapi/Trello/GetCard/${objVar.id}`, 
                    method: "GET",
                    dataType: "json", 
                    //data: data,
                    success: function(data) {
                        // 成功
                        // let jsonCard = JSON.parse(data.output);
                        let jsonCard = data.output;
                        // let aryAllowKey = ['id', 'due', 'desc', 'labels', 'name'];
                        let aryTable=[];

                        aryTable.push('<table>');
                            $.each(jsonCard, function (k, v) {
                                // if (aryAllowKey.indexOf(k) < 0) return; //continute
                                
                                //labels = array
                                if(k=='labels'){

                                    if(v==null || v.length<=0) return; //continute

                                    let aryContent = [];
                                    $.each(v, function (vi, vo) {
                                        aryContent.push(`${vo.name}[${vo.color}]`);
                                    });

                                    aryTable.push('<tr>');
                                    aryTable.push(`<th>${k}</th>`);
                                    aryTable.push(`<td>${aryContent.join(';')}</td>`);
                                    aryTable.push('</tr>');
                                }
                                else if(k=='checklists'){

                                    if(v==null || v.length<=0) return; //continute

                                    $.each(v, function (vi, vo) {
                                        //list
                                        aryTable.push('<tr>');
                                        aryTable.push(`<th>${k}_${vo.name}</th>`);
                                        //items
                                        let aryContent = [];
                                        $.each(vo.checkItems, function (vi, vo) {
                                            aryContent.push(`[${vo.state}] ${vo.name}`);
                                        });
                                        aryTable.push(`<td>${aryContent.join(';')}</td>`);
                                        aryTable.push('</tr>');
                                    });
                                }
                                else if(k=='members'){

                                    if(v==null || v.length<=0) return; //continute

                                    let aryContent = [];
                                    $.each(v, function (vi, vo) {
                                        aryContent.push(`[${vo.username}] ${vo.fullName}`);
                                    });

                                    aryTable.push('<tr>');
                                    aryTable.push(`<th>${k}</th>`);
                                    aryTable.push(`<td>${aryContent.join(';')}</td>`);
                                    aryTable.push('</tr>');
                                }
                                else if(k=='actions'){

                                    if(v==null || v.length<=0) return; //continute

                                    $.each(v, function (vi, vo) {
                                        //actions
                                        aryTable.push('<tr>');
                                        aryTable.push(`<th>${k}_${vi}</th>`);
                                        //data
                                        aryTable.push(`<td>`);
                                        aryTable.push(`${vo.type} | ${vo.data['text']} | [${vo.memberCreator.username}] ${vo.memberCreator.fullName} | ${vo.date}`);
                                        aryTable.push(`</td>`);
                                        aryTable.push('</tr>');
                                    });
                                }
                                else{
                                    aryTable.push('<tr>');
                                    aryTable.push(`<th>${k}</th>`);
                                    aryTable.push(`<td>${v}</td>`);
                                    aryTable.push('</tr>');
                                }
                                    
                            });
                        aryTable.push('</table>');

                        objAreaCardInfo.html(aryTable.join(''));
                    },
                    error: function(xhr, status, error) {
                        objAreaCardInfo.html(`API FAIL`);
                    }
                });
            }

            function getUrlVar() {
                var objVar = {}, hash;
                var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                for (var i = 0; i < hashes.length; i++) {
                    hash = hashes[i].split('=');
                    objVar[hash[0]] = hash[1];
                }
                return objVar;
            }
        });

        var t = TrelloPowerUp.iframe();

        t.render(function () {
            t.sizeTo("#divOuter").done();
        });
        
    </script>
  </body>
</html>